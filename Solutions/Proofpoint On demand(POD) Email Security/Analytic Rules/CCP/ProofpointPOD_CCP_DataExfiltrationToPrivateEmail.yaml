id: aedc5b33-2d7c-42cb-a692-f25ef637cbb2
name: ProofpointPOD CCP - Possible data exfiltration to private email
description: |
  'Detects when sender sent email to the non-corporate domain and recipient's username is the same as sender's username.'
severity: Medium
status: Available 
requiredDataConnectors:
  - connectorId: ProofpointPODEmailSecurity_CCP
    dataTypes:
      - ProofpointPODMessage_CL
queryFrequency: 10m
queryPeriod: 10m
triggerOperator: gt
triggerThreshold: 0
tactics:
  - InitialAccess
relevantTechniques:
  - T1078
query: |
  let lbtime = 10m;
  ProofpointPODMessage_CL
  | where TimeGenerated > ago(lbtime)
  | where tostring(filter.routeDirection) == 'outbound'
  | where array_length(todynamic(tostring(envelope.rcpts))) == 1
  | extend sender = extract(@'\A(.*?)@', 1, tostring(envelope.from))
  | extend sender_domain = extract(@'@(.*)$', 1, tostring(envelope.from))
  | extend recipient = extract(@'\A(.*?)@', 1, tostring(todynamic(tostring(envelope.rcpts))[0]))
  | extend recipient_domain = extract(@'@(.*)$', 1, tostring(todynamic(tostring(envelope.rcpts))[0]))
  | where sender =~ recipient
  | where sender_domain != recipient_domain
  | project SrcUserUpn = tostring(envelope.from), DstUserUpn = tostring(envelope.rcpts)
  | extend AccountCustomEntity = SrcUserUpn
entityMappings:
  - entityType: Account
    fieldMappings:
      - identifier: FullName
        columnName: AccountCustomEntity
version: 1.0.1
kind: Scheduled
