# Testing Instructions: Cisco Umbrella Data Connector with Private Storage Account

## Overview
This document provides step-by-step instructions for testing the Cisco Umbrella data connector deployment with private storage account configuration.

## Prerequisites
Before beginning the deployment, ensure you have:
- An Azure subscription with permissions to create resources
- A Cisco Umbrella account with permissions to access the S3 bucket
- Required information:
  * Cisco Umbrella S3 bucket name
  * AWS Access Key ID with permissions to read from the S3 bucket
  * AWS Secret Access Key
  * Log Analytics Workspace ID and Key

## Deployment Steps

### 1. Repository Setup
```bash
git clone https://github.com/AmudaPalani/Azure-Sentinel.git
cd Azure-Sentinel
git checkout cisco_umbrella_private_storageaccount
```

### 2. Deployment Process
a. Navigate to Azure Portal (https://portal.azure.com)
b. Open Azure Cloud Shell or use Azure CLI locally
c. Navigate to the connector directory:
```bash
cd Solutions/CiscoUmbrella/Data\ Connectors/
```
d. Execute the deployment command:
```bash
az deployment group create --resource-group <your-resource-group> \
  --template-file azuredeploy_CiscoUmbrella_API_FunctionApp.json \
  --parameters FunctionName=<unique-function-name> \
               WorkspaceID=<your-workspace-id> \
               WorkspaceKey=<your-workspace-key> \
               S3Bucket=<your-s3-bucket-name> \
               AWSAccessKeyId=<your-aws-access-key-id> \
               AWSSecretAccessKey=<your-aws-secret-key> \
               AppInsightsWorkspaceResourceID=<your-app-insights-workspace-resource-id>
```

## Verification Steps

### 1. Resource Verification
Navigate to the Azure Portal and verify the creation of:
- Azure Function App
- Storage Account (with private endpoint)
- Virtual Network
- Application Insights
- Private Endpoint connection

### 2. Function App Monitoring
a. Access the Function App in Azure Portal
b. Go to "Functions" > "CiscoUmbrella" > "Monitor"
c. Check logs for any errors
d. First invocation should occur within 5-10 minutes

### 3. Data Ingestion Verification
a. Open your Log Analytics workspace
b. Navigate to "Logs"
c. Run the following KQL query:
```kusto
Cisco_Umbrella
| take 10
```
d. Expect data to appear within 10-15 minutes of deployment

## Security Verification

### Storage Account Security
Verify the following settings:
- Public network access is disabled
- Private endpoint is connected
- No public IP access is allowed

### Function App Security
Confirm:
- VNet integration is active
- System-assigned managed identity is enabled

## Troubleshooting Guide

### If No Data Appears
Check the following:
1. Function App logs for errors
2. AWS credentials and S3 bucket permissions
3. Function App network connectivity to storage account via private endpoint
4. S3 bucket contains recent Cisco Umbrella logs

### Additional Verification Points
- Network Security Group rules
- Private endpoint DNS resolution
- S3 bucket permissions
- Resource deployment status

## Reporting Results

Please provide feedback on:
1. Deployment status (success/failure)
2. Any error messages encountered
3. Data flow status in Log Analytics
4. Any networking or permission issues

## Support
For any issues during testing, please check:
- Function App logs
- Network configuration
- Azure Portal deployment status
- AWS credentials and permissions
